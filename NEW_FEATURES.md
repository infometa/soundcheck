# 新增功能说明 (New Features)

## 📋 概述

在原有功能的基础上，新增了以下两个重要功能：

1. **改进的设备选择** - 分别显示和选择麦克风、扬声器
2. **IR分离导出** - 将脉冲响应分离为直达声、早反射、混响尾声，并导出为单独的WAV文件

---

## 🎤 功能1: 改进的设备选择

### 问题背景
原来的设备选择界面混合显示所有设备，当你有多个麦克风和扬声器时不容易区分。

### 新功能
现在会**分别显示**：
- 🎤 **麦克风设备列表** (输入设备)
- 🔊 **扬声器设备列表** (输出设备)

### 使用示例

运行 `python3 run.py` 时，你会看到：

```
============================================================
🎤 可用麦克风设备 (输入)
============================================================
   0. Built-in Microphone                       (2通道) [默认]
   1. USB Audio Device                          (1通道)
   2. Focusrite Scarlett 2i2                    (2通道)

============================================================
🔊 可用扬声器设备 (输出)
============================================================
   3. Built-in Speakers                         (2通道) [默认]
   4. USB Audio Device                          (2通道)
   5. Focusrite Scarlett 2i2                    (2通道)

============================================================
选择麦克风ID (默认: 0): 2
选择扬声器ID (默认: 3): 5

✅ 已设置音频设备:
   🎤 麦克风: Focusrite Scarlett 2i2
   🔊 扬声器: Focusrite Scarlett 2i2
```

### 新特性
- ✅ 分别列出输入/输出设备
- ✅ 显示每个设备的通道数
- ✅ 标记默认设备
- ✅ 支持直接按回车使用默认设备
- ✅ 验证设备有效性（防止选错）

**文件**: `core/device.py`

---

## 📁 功能2: IR分离导出

### 问题背景
测量得到的脉冲响应(IR)包含了直达声、早反射和混响尾声，但之前只能得到一个完整的IR文件，不方便对比分析各部分的特性。

### 新功能
自动将IR分离为三个独立的部分，并导出为单独的WAV文件：

1. 🔴 **直达声** (Direct Sound) - 声音从扬声器直接到达麦克风
2. 🔵 **早反射** (Early Reflections) - 墙壁、天花板、地面的早期反射
3. ⚪ **混响尾声** (Late Reverb) - 后期混响能量

### 分离原理

```
时间轴:  [====|========|====================...]
         直达声  早反射    混响尾声
         ±5ms   0-80ms    80ms-结束
```

- **直达声窗口**: 峰值前后各5ms
- **早反射窗口**: 直达声结束到80ms后（可在配置文件调整）
- **混响尾声**: 80ms之后的所有能量

### 输出文件

每次测量后，会在 `data/separated/` 目录生成：

```
data/separated/
├── direct_sound.wav        # 直达声（单声道）
├── early_reflections.wav   # 早反射（单声道）
├── late_reverb.wav         # 混响尾声（单声道）
└── comparison.wav          # 4通道对比文件（见下文）
```

### 能量分析

导出时会显示详细的能量分析：

```
============================================================
📁 IR分离完成 - 已保存为单独的WAV文件
============================================================
🔴 直达声:     data/separated/direct_sound.wav
   时间窗口:   15.8 - 25.8 ms
   能量占比:   30.1%

🔵 早反射:     data/separated/early_reflections.wav
   时间窗口:   25.8 - 100.8 ms
   能量占比:   60.9%

⚪ 混响尾声:   data/separated/late_reverb.wav
   时间窗口:   100.8 ms - 结束
   能量占比:   9.0%
============================================================
```

### 对比文件 (comparison.wav)

特别导出一个**4通道WAV文件**，方便在DAW中对比：

- **通道1**: 完整IR
- **通道2**: 直达声
- **通道3**: 早反射
- **通道4**: 混响尾声

**使用方法**：
1. 在Reaper、Pro Tools、Logic等DAW中导入 `comparison.wav`
2. 会自动分为4个轨道
3. 可以单独静音/独奏每个部分进行对比
4. 可以查看频谱对比

### 配置参数

可以在 `config/params.yaml` 中调整早反射时间窗口：

```yaml
early_reflection_time: 0.08  # 80ms，适用于中小型房间
# 大房间可设置为 0.10-0.15 (100-150ms)
```

### 实际应用

这些分离的文件可以用于：

1. **声学分析**
   - 对比直达声和反射的能量比
   - 分析早反射的频率响应
   - 研究混响尾声的衰减特性

2. **声学处理指导**
   - 如果早反射能量过高 → 需要吸音处理
   - 如果混响尾声过长 → 需要扩散处理
   - 直达声能量不足 → 重新摆放扬声器

3. **房间对比**
   - 测量不同位置的IR
   - 对比分离文件，找到最佳听音位

4. **声学效果设计**
   - 在DAW中使用这些IR创建卷积混响
   - 分别处理早反射和混响尾声
   - 设计特定的声学效果

### API使用

如果你想在自己的脚本中使用分离功能：

```python
from core.separate import separate_ir_components, export_ir_comparison

# 分离IR并保存为单独文件
paths = separate_ir_components(ir, output_dir="my_output")

# 获取文件路径
direct_path = paths['direct']    # 直达声
early_path = paths['early']      # 早反射
late_path = paths['late']        # 混响尾声

# 导出4通道对比文件
comparison_path = export_ir_comparison(ir, output_path="my_output/comparison.wav")
```

**文件**: `core/separate.py`

---

## 🎯 测试验证

运行测试脚本验证新功能：

```bash
python3 test_fixes.py
```

测试会自动：
- ✅ 生成合成IR
- ✅ 分离为三个部分
- ✅ 验证文件存在
- ✅ 检查文件大小
- ✅ 生成4通道对比文件

---

## 📊 完整工作流程

现在的完整测量流程包括9个步骤：

```
[1/9] 选择音频设备         ← 新：分别选择麦克风和扬声器
[2/9] 生成扫频信号
[3/9] 播放并录制
[4/9] 同步和裁剪录音
[5/9] 提取脉冲响应 (IR)
[6/9] 计算声学指标
[7/9] 检测反射并绘制图表
[8/9] 分离IR成分并导出WAV   ← 新：导出直达声/早反射/混响
[9/9] 生成PDF报告
```

### 输出文件清单

```
soundcheck/
├── data/
│   ├── plots/
│   │   └── ir.png                         # IR波形+ETC图表
│   ├── reports/
│   │   └── report.pdf                     # PDF声学测试报告
│   ├── separated/                         # ← 新增目录
│   │   ├── direct_sound.wav               # ← 直达声
│   │   ├── early_reflections.wav          # ← 早反射
│   │   ├── late_reverb.wav                # ← 混响尾声
│   │   └── comparison.wav                 # ← 4通道对比文件
│   ├── processed/
│   │   └── ir.wav                         # 完整IR
│   └── raw/
│       ├── sweep.wav                      # 扫频信号
│       ├── rec.wav                        # 原始录音
│       └── inv.npy                        # 逆滤波器
```

---

## 💡 使用技巧

### 技巧1: 快速使用默认设备

如果你只有一个麦克风和一个扬声器，直接按两次回车即可：

```
选择麦克风ID (默认: 0): ↵
选择扬声器ID (默认: 3): ↵
```

### 技巧2: 在DAW中对比

1. 打开Reaper/Pro Tools等DAW
2. 导入 `data/separated/comparison.wav`
3. 设置4个轨道的颜色：
   - 轨道1: 白色（完整IR）
   - 轨道2: 红色（直达声）
   - 轨道3: 蓝色（早反射）
   - 轨道4: 灰色（混响尾声）
4. 独奏不同轨道对比听感

### 技巧3: 调整早反射时间窗口

根据房间大小调整 `config/params.yaml`:

```yaml
# 小房间 (< 20㎡)
early_reflection_time: 0.05  # 50ms

# 中等房间 (20-50㎡)
early_reflection_time: 0.08  # 80ms (默认)

# 大房间 (> 50㎡)
early_reflection_time: 0.12  # 120ms

# 音乐厅
early_reflection_time: 0.15  # 150ms
```

---

## 📝 技术细节

### 归一化处理

所有分离的文件都保持**相对能量关系**：
- 使用完整IR的峰值归一化
- 三个文件的能量总和等于完整IR
- 可以直接对比各部分能量

### 采样率

所有WAV文件使用配置文件中的采样率（默认48kHz）：

```yaml
fs: 48000  # 可改为44100或96000
```

### 文件格式

- **单声道WAV**: 直达声、早反射、混响尾声
- **4通道WAV**: 对比文件
- **位深度**: 自动（soundfile默认）

---

## ❓ 常见问题

**Q: 为什么直达声文件有些安静？**
A: 这是正常的。归一化是基于完整IR，所以各部分的响度反映了真实的能量比例。

**Q: 可以只导出某一部分吗？**
A: 可以。查看 `core/separate.py` 的API，单独调用函数。

**Q: 4通道文件在某些播放器中无法播放？**
A: 使用专业DAW或Audacity打开多通道文件。VLC等播放器可能只播放第一通道。

**Q: 能否导出为其他格式？**
A: WAV是无损格式，最适合声学分析。如需其他格式，可以用ffmpeg转换。

---

## 🎓 相关资源

- ISO 3382: 室内声学测量标准
- 早反射与混响的关系：通常早反射/混响比决定清晰度
- C50指标：正是基于50ms分界点计算早期/后期能量比

---

## 📞 技术支持

如有问题，请检查：
1. 配置文件 `config/params.yaml`
2. 测试脚本 `python3 test_fixes.py`
3. 详细文档 `FIXES_SUMMARY.md`

Happy acoustic measuring! 🎵
